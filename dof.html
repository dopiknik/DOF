<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>F8-like LensKit — Panasonic S5IIX (35/50/85mm)</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  /* Minimalist dark theme inspired by F8 */
  :root{
    --bg: #05121a;
    --panel: #081623;
    --muted: #94a3b8;
    --accent: #73d0ff;
    --accent-2: #7ef0c2;
    --glass: rgba(255,255,255,0.03);
    --card-shadow: 0 8px 40px rgba(2,8,12,0.6);
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    color: #eaf5ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#03121a 0%, #051827 100%);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .container{max-width:1200px;margin:22px auto;padding:20px;display:grid;grid-template-columns:360px 1fr;gap:20px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:var(--card-shadow);border:1px solid rgba(255,255,255,0.03)}
  h1{margin:0;font-size:18px}
  p.lead{margin:8px 0 14px;color:var(--muted);font-size:13px}
  label{display:block;color:var(--muted);font-size:12px;margin-top:12px}
  select,input[type="number"],input[type="range"]{width:100%;padding:8px;border-radius:8px;border:none;background:var(--glass);color:var(--accent);font-weight:700}
  .lens-pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--accent);font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .pill.active{background:linear-gradient(90deg,var(--accent),#8dd9ff);color:#042033}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .small{font-size:12px;color:var(--muted)}
  .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:12px}
  .tile{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
  .tile .label{font-size:12px;color:var(--muted)}
  .canvas-wrap{margin-top:12px}
  canvas{width:100%;height:320px;border-radius:8px;background:linear-gradient(180deg,#031f27,#021019)}
  button{background:linear-gradient(90deg,var(--accent),#8bd9ff);border:none;padding:10px 14px;border-radius:10px;font-weight:800;color:#05242f;cursor:pointer;margin-top:10px}
  .footer{margin-top:12px;color:var(--muted);font-size:12px}
  .controls{display:flex;flex-direction:column;gap:8px}
  .inline{display:flex;gap:8px;align-items:center}
  .kbd{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:6px;color:var(--accent);font-weight:800;font-size:13px}
  @media(max-width:980px){
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }

  .container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    padding: 8px;
    gap: 8px;
  }

  /* Порядок блоков */
  [aria-label="results"] {
    order: 1;
    flex-shrink: 0;
  }

  [aria-label="results"] .canvas-wrap {
    margin-top: 6px;
  }

  [aria-label="results"] canvas {
    height: 160px;
  }

  [aria-label="controls"] {
    order: 2;
    overflow-y: auto;
    flex: 1;
  }

  /* Уплотнение элементов */
  .controls {
    gap: 4px;
  }

  label {
    font-size: 11px;
    margin-top: 6px;
  }

  input[type="number"],
  input[type="range"],
  select {
    font-size: 13px;
    padding: 6px;
  }

  button {
    padding: 8px 10px;
    font-size: 13px;
  }

  h1 {
    font-size: 16px;
  }

  p.lead {
    font-size: 12px;
    margin-bottom: 8px;
  }

  .metrics {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 6px;
  }

  .tile {
    padding: 6px;
  }

  .tile .label {
    font-size: 11px;
  }

  .footer {
    font-size: 11px;
  }

  /* Скрыть часть второстепенных подписей для компактности */
  .inline .small {
    display: none;
  }

  /* Основные параметры наверху в блоке controls */
  #focal, #aperture, #distance {
    font-weight: 700;
    color: var(--accent);
    background: rgba(255,255,255,0.04);
  }

  /* Контейнер прокручивается, но всё в одном экране */
  [aria-label="controls"]::-webkit-scrollbar {
    width: 4px;
  }
  [aria-label="controls"]::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.08);
    border-radius: 2px;
  }
}
</style>
</head>
<body>
  <div class="container">
    <div class="card" role="region" aria-label="controls">
      <h1>LensKit — DOF & FOV для твоей системы</h1>
      <p class="lead">Panasonic S5IIX (Full Frame). Оптика: <strong>35 / 50 / 85 mm (ƒ/1.8)</strong>. Полный DOF-калькулятор + bias (сдвиг плоскости фокуса) + экспорт.</p>

      <div class="controls">
        <label>Формат / сенсор</label>
        <select id="format">
          <option value="ff">Full Frame — 36.0 × 24.0 мм (Panasonic S5IIX)</option>
          <option value="s35">Super35 — crop ≈ 1.5 (24.0 × 16.0 мм)</option>
          <option value="custom">Пользовательский</option>
        </select>

        <div id="customBlock" style="display:none">
          <label>Ширина сенсора (мм)</label>
          <input type="number" id="sensorW" value="36" step="0.01">
          <label>Высота сенсора (мм)</label>
          <input type="number" id="sensorH" value="24" step="0.01">
          <label>CoC (мм)</label>
          <input type="number" id="coc" value="0.030" step="0.001">
        </div>

        <label>Выбери объектив</label>
        <div class="lens-pills" id="lensPills">
          <div class="pill" data-f="35" data-max="1.8">35 mm ƒ/1.8</div>
          <div class="pill active" data-f="50" data-max="1.8">50 mm ƒ/1.8</div>
          <div class="pill" data-f="85" data-max="1.8">85 mm ƒ/1.8</div>
        </div>

        <label>Фокусное (мм)</label>
        <input type="number" id="focal" value="50" step="0.1" min="1">

        <label>Диафрагма (ƒ)</label>
        <input type="number" id="aperture" value="5.6" step="0.1" min="0.7">

        <label>Дистанция до объекта</label>
        <div class="row">
          <div class="col">
            <input type="number" id="distance" value="2.00" step="0.01" min="0.01">
          </div>
          <div class="col">
            <select id="units"><option value="m">м</option><option value="ft">ft</option></select>
          </div>
        </div>

        <label>Bias — сдвиг плоскости фокуса (м) <span class="small">положительное — фокус дальше объекта; отрицательное — ближе к камере</span></label>
        <input type="range" id="bias" min="-2" max="2" step="0.01" value="0">
        <div class="inline"><div class="kbd" id="biasVal">0.00 м</div><div class="small" style="margin-left:6px;color:var(--muted)">Сдвиг влияет только на позицию плоскости фокуса (object distance + bias = focus distance)</div></div>

        <label>Опции</label>
        <div class="inline">
          <button id="calc">Рассчитать</button>
          <button id="exportCsv">Экспорт CSV</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:6px;align-items:center;">
          <button id="resetBiasBtn" style="background:linear-gradient(90deg,#ff8a65,#ffb085);">Сбросить Bias</button>
        </div>

        <div class="footer">CoC по умолчанию: 0.030 мм (Full Frame). Для кинопроизводства можно менять CoC вручную.</div>
      </div>
    </div>

    <div class="card" role="region" aria-label="results">
      <h1>Результаты</h1>
      <p class="lead">Near / Far / Total DOF, Hyperfocal, FOV и визуализация плоскости фокуса относительно объекта.</p>

      <div class="metrics" id="metrics">
        <div class="tile"><div class="label">Near</div><div id="near" style="font-weight:800;font-size:16px">—</div></div>
        <div class="tile"><div class="label">Far</div><div id="far" style="font-weight:800;font-size:16px">—</div></div>
        <div class="tile"><div class="label">Total DOF</div><div id="total" style="font-weight:800;font-size:16px">—</div></div>
        <div class="tile"><div class="label">Hyperfocal</div><div id="hyper" style="font-weight:800;font-size:16px">—</div></div>
        <div class="tile"><div class="label">FOV (H × V × D)</div><div id="fov" style="font-weight:800;font-size:14px">—</div></div>
        <div class="tile"><div class="label">Focus distance used</div><div id="focusUsed" style="font-weight:800;font-size:14px">—</div></div>
      </div>

      <div class="canvas-wrap">
        <canvas id="vis" aria-label="visualization"></canvas>
      </div>

      <div class="footer">Алгоритмы основаны на стандартных оптических формулах. Bias = смещение плоскости фокуса (focusDistance = objectDistance + bias).</div>
    </div>
  </div>

<script>
/* Core logic — DOF, FOV, bias, visualization, export CSV
   Формулы:
   H (mm) = (f^2) / (N * c) + f
   s_near = (H * s) / (H + (s - f))
   s_far  = (H * s) / (H - (s - f))  (если s < H, иначе Infinity)
   DOF = s_far - s_near
   FOV_dim = 2 * atan(dim / (2 * f)) (radians -> degrees)
   Все длины внутри — мм (конвертация из метров)
*/

const formatEl = document.getElementById('format');
const customBlock = document.getElementById('customBlock');
const sensorWEl = document.getElementById('sensorW');
const sensorHEl = document.getElementById('sensorH');
const cocEl = document.getElementById('coc');

const lensPills = document.querySelectorAll('.pill');
const focalEl = document.getElementById('focal');
const apertureEl = document.getElementById('aperture');
const distanceEl = document.getElementById('distance');
const unitsEl = document.getElementById('units');
const biasEl = document.getElementById('bias');
const biasVal = document.getElementById('biasVal');
const calcBtn = document.getElementById('calc');
const resetBiasBtn = document.getElementById('resetBiasBtn');
const exportBtn = document.getElementById('exportCsv');

const nearOut = document.getElementById('near');
const farOut = document.getElementById('far');
const totalOut = document.getElementById('total');
const hyperOut = document.getElementById('hyper');
const fovOut = document.getElementById('fov');
const focusUsedOut = document.getElementById('focusUsed');

const canvas = document.getElementById('vis');
const ctx = canvas.getContext('2d');

let sensor = {w:36.0, h:24.0, coc:0.030}; // defaults for Panasonic S5IIX

// Predefined lens data (your lenses). All max apertures = 1.8 as requested.
const lenses = {
  "35": {f:35, maxA:1.8, close:0.28},
  "50": {f:50, maxA:1.8, close:0.45},
  "85": {f:85, maxA:1.8, close:0.85}
};

// helper
function toMM(m){ return m * 1000; }
function toM(mm){ return mm / 1000; }
function fmt(val, u='m'){ if(!isFinite(val)) return '∞'; if(u==='ft') return (val*3.2808399).toFixed(3) + ' ft'; return val.toFixed(3) + ' м'; }

function updateSensorFromFormat(){
  const v = formatEl.value;
  if(v==='ff'){ sensor.w=36; sensor.h=24; sensor.coc=0.030; customBlock.style.display='none'; }
  else if(v==='s35'){ sensor.w=24; sensor.h=16; sensor.coc=0.025; customBlock.style.display='none'; }
  else { customBlock.style.display='block'; sensor.w = parseFloat(sensorWEl.value) || 36; sensor.h = parseFloat(sensorHEl.value) || 24; sensor.coc = parseFloat(cocEl.value) || 0.030; }
}

// compute DOF given focusDistance (s) in meters
function computeDOF_mm(f_mm, N, coc_mm, sensor_w_mm, sensor_h_mm, s_m){
  const s_mm = toMM(s_m); // mm
  const f = f_mm;
  const c = coc_mm;
  // Hyperfocal
  const H = (f*f) / (N * c) + f;
  const s_minus_f = s_mm - f;
  const s_near = (H * s_mm) / (H + s_minus_f);
  let s_far;
  if(s_mm >= H) s_far = Infinity;
  else s_far = (H * s_mm) / (H - s_minus_f);
  const dof_mm = isFinite(s_far) ? (s_far - s_near) : Infinity;
  const w = sensor_w_mm, h = sensor_h_mm;
  const diag = Math.sqrt(w*w + h*h);
  const fov = (dim) => 2 * Math.atan(dim / (2 * f)) * (180/Math.PI);
  return {
    H_mm: H,
    near_mm: s_near,
    far_mm: s_far,
    dof_mm: dof_mm,
    fov_h: fov(w),
    fov_v: fov(h),
    fov_d: fov(diag)
  };
}

// visualization
function drawVis(res, object_m, focus_m){
  // set canvas pixel ratio
  const DPR = devicePixelRatio || 1;
  canvas.width = canvas.clientWidth * DPR;
  canvas.height = canvas.clientHeight * DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);

  // background
  const g = ctx.createLinearGradient(0,0,0,canvas.clientHeight);
  g.addColorStop(0,'#04222b'); g.addColorStop(1,'#021018');
  ctx.fillStyle = g; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);

  const pad = 38;
  const left = pad;
  const right = canvas.clientWidth - pad;
  const midY = canvas.clientHeight / 2;

  // map distances to x
  const maxDist = Math.max(object_m*1.6, focus_m*1.6, toM(res.H_mm)*1.1, 10);
  const mapX = (d) => left + (right - left) * Math.min(1, d / maxDist);

  // camera icon
  ctx.fillStyle = '#9ae6ff'; ctx.fillRect(left-6, midY-20, 12, 40);
  ctx.fillStyle = '#bfeeff'; ctx.font='12px Inter, Arial'; ctx.fillText('Камера', left-22, midY-28);

  // object
  const objX = mapX(object_m);
  ctx.fillStyle = '#ffd38a'; ctx.beginPath(); ctx.arc(objX, midY-70, 9, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#ffd38a'; ctx.font='12px Inter'; ctx.fillText('Объект ' + object_m.toFixed(2) + ' м', objX-36, midY-86);

  // focus plane
  const focusX = mapX(focus_m);
  ctx.strokeStyle = '#7ef0c2'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(focusX, 10); ctx.lineTo(focusX, canvas.clientHeight-10); ctx.stroke();
  ctx.fillStyle = '#7ef0c2'; ctx.fillText('Плоскость фокуса ' + focus_m.toFixed(2) + ' м', Math.max(10, focusX-90), canvas.clientHeight-12);

  // near/far bounds
  const near_m = toM(res.near_mm);
  const far_m = isFinite(res.far_mm) ? toM(res.far_mm) : Infinity;
  const nearX = mapX(near_m);
  const farX = isFinite(far_m) ? mapX(far_m) : right;

  // DOF band
  ctx.fillStyle = 'rgba(115,208,255,0.12)';
  ctx.fillRect(nearX, 10, Math.max(2, farX - nearX), canvas.clientHeight-40);
  ctx.strokeStyle = 'rgba(115,208,255,0.25)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(nearX, 10); ctx.lineTo(nearX, canvas.clientHeight-30); ctx.moveTo(farX, 10); ctx.lineTo(farX, canvas.clientHeight-30); ctx.stroke();

  // labels
  ctx.fillStyle = '#aee7ff';
  ctx.font = '12px Inter';

  let nearLabelX = Math.min(nearX + 6, canvas.clientWidth - 120);
  let farLabelX  = Math.min(farX - 60, canvas.clientWidth - 200);

  // если подписи пересекаются — сдвинем Far правее
  if (Math.abs(farLabelX - nearLabelX) < 80) {
    farLabelX = nearLabelX + 80;
  }

  ctx.fillText('Near: ' + (isFinite(near_m) ? near_m.toFixed(2) + ' м' : '—'), nearLabelX, 18);
  ctx.fillText('Far: ' + (isFinite(far_m) ? far_m.toFixed(2) + ' м' : '∞'), farLabelX, 18);
  // rays schematic
  ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth=1;
  for(let i=0;i<9;i++){
    const t = i/8;
    const x = left + 12 + t * (right-left-40);
    ctx.beginPath(); ctx.moveTo(left+12, midY); ctx.lineTo(x, midY + (t-0.5)*40); ctx.stroke();
  }

  // small FOV box
  ctx.strokeStyle='rgba(115,208,255,0.25)';
  ctx.strokeRect(canvas.clientWidth-148, 14, 132, 68);
  ctx.fillStyle = '#a6e9ff'; ctx.font='11px Inter'; ctx.fillText('Схема FOV', canvas.clientWidth-148, 12);
}

// main compute + UI update
function computeAndRender(){
  updateSensorFromFormat();
  // read inputs
  const f_mm = parseFloat(focalEl.value) || 50;
  const N = parseFloat(apertureEl.value) || 5.6;
  const objDist = parseFloat(distanceEl.value) || 2.0;
  const bias = parseFloat(biasEl.value) || 0.0;
  biasVal.textContent = bias.toFixed(2) + ' м';
  const units = unitsEl.value;

  // focus distance used = object + bias
  let focusDist = objDist + bias;
  if(focusDist < 0.01) focusDist = 0.01;

  const res = computeDOF_mm(f_mm, N, sensor.coc, sensor.w, sensor.h, focusDist);

  // outputs formatted in selected units
  const u = units==='ft' ? 'ft' : 'm';
  nearOut.textContent = fmt(toM(res.near_mm), u);
  farOut.textContent = isFinite(res.far_mm) ? fmt(toM(res.far_mm), u) : '∞';
  totalOut.textContent = isFinite(res.dof_mm) ? fmt(res.dof_mm/1000, u) : '∞';
  hyperOut.textContent = fmt(toM(res.H_mm), u);
  fovOut.textContent = res.fov_h.toFixed(1) + '° × ' + res.fov_v.toFixed(1) + '° × ' + res.fov_d.toFixed(1) + '°';
  focusUsedOut.textContent = focusDist.toFixed(3) + ' м (object ' + objDist.toFixed(3) + ' м + bias ' + bias.toFixed(3) + ' м)';

  drawVis(res, objDist, focusDist);

  // return structure for export
  return {
    f_mm, N, coc_mm: sensor.coc, sensor_w_mm: sensor.w, sensor_h_mm: sensor.h,
    object_m: objDist, bias_m: bias, focus_m: focusDist,
    near_m: toM(res.near_mm), far_m: isFinite(res.far_mm) ? toM(res.far_mm) : Infinity, total_m: isFinite(res.dof_mm) ? res.dof_mm/1000 : Infinity,
    hyper_m: toM(res.H_mm), fov_h: res.fov_h, fov_v: res.fov_v, fov_d: res.fov_d
  };
}

// wiring events
formatEl.addEventListener('change', ()=>{ updateSensorFromFormat(); computeAndRender(); });
sensorWEl.addEventListener('change', ()=>{ sensor.w = parseFloat(sensorWEl.value) || 36; computeAndRender(); });
sensorHEl.addEventListener('change', ()=>{ sensor.h = parseFloat(sensorHEl.value) || 24; computeAndRender(); });
cocEl && cocEl.addEventListener('change', ()=>{ sensor.coc = parseFloat(cocEl.value) || 0.03; computeAndRender(); });

lensPills.forEach(el => el.addEventListener('click', ()=>{
  lensPills.forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  const f = parseFloat(el.dataset.f);
  const maxap = parseFloat(el.dataset.max);
  focalEl.value = f.toFixed(1);
  apertureEl.value = Math.max(1.0, Math.min(11, Math.round(maxap*10)/10 * 1.6)).toFixed(1); // set a reasonable base
  computeAndRender();
}));

[focalEl, apertureEl, distanceEl, unitsEl, biasEl].forEach(inp => inp.addEventListener('change', computeAndRender));
biasEl.addEventListener('input', ()=>{ biasVal.textContent = parseFloat(biasEl.value).toFixed(2) + ' м'; computeAndRender(); });

calcBtn.addEventListener('click', computeAndRender);
resetBiasBtn.addEventListener('click', ()=>{ 
  biasEl.value = 0; 
  biasVal.textContent = '0.00 м'; 
  computeAndRender(); 
});

exportBtn.addEventListener('click', ()=>{
  const d = computeAndRender();
  // CSV: one-line with key params
  const headers = ['camera','sensor_w_mm','sensor_h_mm','coc_mm','f_mm','aperture','object_m','bias_m','focus_m','near_m','far_m','total_dof_m','hyperfocal_m','fov_h_deg','fov_v_deg','fov_d_deg'];
  const row = [
    'Panasonic S5IIX',
    d.sensor_w_mm.toFixed(3), d.sensor_h_mm.toFixed(3), d.coc_mm.toFixed(4),
    d.f_mm.toFixed(3), d.N.toFixed(2), d.object_m.toFixed(3), d.bias_m.toFixed(3), d.focus_m.toFixed(3),
    (isFinite(d.near_m)?d.near_m.toFixed(4):'inf'),
    (isFinite(d.far_m)?d.far_m.toFixed(4):'inf'),
    (isFinite(d.total_m)?d.total_m.toFixed(4):'inf'),
    (isFinite(d.hyper_m)?d.hyper_m.toFixed(4):'inf'),
    d.fov_h.toFixed(3), d.fov_v.toFixed(3), d.fov_d.toFixed(3)
  ];
  const csv = headers.join(',') + '\n' + row.join(',');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'lenskit_export.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1500);
});

// initial render
updateSensorFromFormat();
computeAndRender();
</script>
</body>
</html>
